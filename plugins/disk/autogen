#! /bin/sh
#  -*- Mode: C; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
#  vi: set tabstop=4 shiftwidth=4 expandtab: */
# ***** BEGIN LICENSE BLOCK *****
# Copyright (C) 2009 Zmanda Incorporated. All Rights Reserved.
#
# This file is part of libzcloud.
#
# libzcloud is free software: you can redistribute it and/or modify
# it under the terms of the GNU Lesser General Public License (the LGPL)
# as published by the Free Software Foundation, either version 2.1 of
# the LGPL, or (at your option) any later version.
#
# libzcloud is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Lesser General Public License for more details.
#  ***** END LICENSE BLOCK *****

is_local=false
if test "$1" = "local"; then
    is_local=true
fi

# cd to the directory we're run from
cd `dirname $0`

# if you change this, please also change it in the root Makefile.am
includes=""

die() {
    echo x"${@}" | sed 's/^x//'
    exit 1
}

# clean up
rm -f aclocal.m4
rm -rf autom4te*.cache
rm -f configure

echo "..aclocal"
aclocal $includes || die "aclocal failed"

echo "...aclocal patches"
# See http://bugzilla.gnome.org/show_bug.cgi?id=418778
#
# The Glib developers are a bit over-eager in their version requirements, requiring
# an unnecessarily high verison of pkg-config at configure time, when they really
# only need it at autogen time.  This patch resets the version number in the file
# just generated by aclocal to the version we've been requiring all along.
sed -e  \
     's/PKG_PROG_PKG_CONFIG(\[0\.16\])/PKG_PROG_PKG_CONFIG([0.7])/g' \
     < aclocal.m4 > aclocal.m4~
mv aclocal.m4~ aclocal.m4

echo "..autoconf"
autoconf || die "autoconf failed"

echo "..automake"
automake --force --copy --warnings=none || die "automake failed"
